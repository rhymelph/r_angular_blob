<p><img src="https://user-gold-cdn.xitu.io/2020/6/12/172a70ba95520695?w=648&h=261&f=png&s=15189" alt="" /></p>
<h2>ä»‹ç»</h2>
<p>åœ¨ç§»åŠ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨å‡çº§æ˜¯å¿…ä¸å¯å°‘çš„ä¸€ä¸ªç¯èŠ‚ï¼Œæ‰€ä»¥ï¼Œ<a href="https://github.com/rhymelph/r_upgrade">r_upgrade</a>åº”ç”¨å‡çº§æ’ä»¶å°±å‡ºç°äº†ï¼Œè¿™é‡Œå…ˆé¼“æŒæ¬¢è¿ğŸ‘ğŸ‘ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨ä»‹ç»</p>
<h1>r_upgrade</h1>
<p><a href="https://pub.dartlang.org/packages/r_upgrade"><img src="https://img.shields.io/pub/v/r_upgrade.svg" alt="pub package" /></a></p>
<p>Androidå’ŒIOSçš„å‡çº§åº”ç”¨æ’ä»¶==Flutteråº”ç”¨å‡çº§æ’ä»¶</p>
<ul>
<li>ç½‘é¡µé“¾æ¥å½¢å¼å‡çº§</li>
<li>apkä¸‹è½½å½¢å¼å‡çº§<code>ä½¿ç”¨Serviceæˆ–è€…DownloadManager</code></li>
<li>è·³è½¬åˆ°åº”ç”¨å•†åº—å‡çº§</li>
<li><code>Android</code>çƒ­æ›´æ–°</li>
<li><code>Android</code>å¢é‡å‡çº§</li>
</ul>
<h2>å¼€å§‹å§</h2>
<h3>1.ä½¿ç”¨æ’ä»¶:</h3>
<p>åœ¨<code>pubspec.yaml</code>æ–‡ä»¶æ·»åŠ ä¸‹é¢ä»£ç </p>
<pre><code class="language-yaml">dependencies:
  r_upgrade: last version
</code></pre>
<h3>2.ä½¿ç”¨æ‰“å¼€é“¾æ¥çš„æ–¹å¼è¿›è¡Œæ›´æ–°ï¼ˆ<code>Android</code>å’Œ<code>IOS</code>é€šç”¨ï¼‰</h3>
<pre><code class="language-dart">    void upgradeFromUrl()async{
        bool isSuccess =await RUpgrade.upgradeFromUrl(
                    'https://www.baidu.com',
                  );
        print(isSuccess);
    }
</code></pre>
<h2>Androidå¹³å°</h2>
<h3>1.è·³è½¬åˆ°åº”ç”¨å•†åº—å‡çº§</h3>
<pre><code class="language-dart">    void upgradeFromAndroidStore(){
       bool isSuccess = await RUpgrade.upgradeFromAndroidStore(AndroidStore.BAIDU);
       print('${isSuccess?'è·³è½¬æˆåŠŸ':'è·³è½¬å¤±è´¥'}');
    }
</code></pre>
<h3>2.é€šè¿‡ä¸‹è½½é“¾æ¥è¿›è¡Œapkä¸‹è½½</h3>
<blockquote>
<p>æ³¨æ„ï¼Œåœ¨Androidåº”ç”¨ä¸­ï¼Œè¯·ç¡®ä¿<code>AndroidManifest.xml</code>ä¸­å£°æ˜ä»¥ä¸‹æƒé™ï¼Œå¹¶åœ¨6.0ç³»ç»Ÿä¸Šè¿›è¡ŒåŠ¨æ€æˆæƒï¼Œä¸ç„¶ä¼šè°ƒç”¨å‡çº§æ–¹æ³•å°†æŠ›å‡ºæƒé™å¼‚å¸¸</p>
</blockquote>
<pre><code class="language-xml">    &lt;uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES" /&gt;
    &lt;uses-permission android:name="android.permission.INTERNET"/&gt;
    &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
</code></pre>
<h4>1.æ·»åŠ å‡çº§ä¸‹è½½è¿›åº¦ç›‘å¬</h4>
<pre><code class="language-dart">RUpgrade.stream.listen((DownloadInfo info){
  ///...
});
</code></pre>
<p>info é‡ŒåŒ…å«çš„ä¿¡æ¯å¦‚ä¸‹:</p><table><thead><tr><th>å­—æ®µ</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>(int) id</td><td>å½“å‰ä¸‹è½½ä»»åŠ¡çš„id</td></tr><tr><td>(int) max_length</td><td>æ‰€éœ€ä¸‹è½½çš„æ€»å¤§å° (bytes)</td></tr><tr><td>(int) current_length</td><td>å½“å‰å·²ä¸‹è½½çš„å¤§å° (bytes)</td></tr><tr><td>(double) percent</td><td>å½“å‰ä¸‹è½½è¿›åº¦(0-100)</td></tr><tr><td>(double) planTime</td><td>è®¡åˆ’ä¸‹è½½å®Œæˆæ‰€éœ€æ—¶é—´/ç§’ (éœ€è¦.toStringAsFixed(0))</td></tr><tr><td>(String) path</td><td>å½“å‰ä¸‹è½½çš„æ–‡ä»¶è·¯å¾„</td></tr><tr><td>(double) speed</td><td>å½“å‰ä¸‹è½½çš„é€Ÿåº¦kb/s</td></tr><tr><td>(DownloadStatus) status</td><td>å½“å‰ä¸‹è½½çŠ¶æ€ <br> <code>STATUS_PAUSED</code> ä¸‹è½½å·²æš‚åœ <br> <code>STATUS_PENDING</code>ç­‰å¾…ä¸‹è½½ <br> <code>STATUS_RUNNING</code>ä¸‹è½½ä¸­ <br> <code>STATUS_SUCCESSFUL</code>ä¸‹è½½æˆåŠŸ <br> <code>STATUS_FAILED</code>ä¸‹è½½å¤±è´¥ <br> <code>STATUS_CANCEL</code>ä¸‹è½½å–æ¶ˆ</td></tr></tbody></table>
<p>æ³¨æ„ï¼š éƒ¨åˆ†httpä¸‹è½½é“¾æ¥å¯èƒ½è¿”å› <code>max_length = -1</code>ï¼Œè¯·è‡ªè¡Œåˆ¤æ–­</p>
<h4>2.ç«‹å³å‡çº§ä½ çš„åº”ç”¨</h4>
<p>ç›®å‰åˆ†ä¸ºä¸¤éƒ¨åˆ†
<code>useDownloadManager</code>:</p>
<ul>
<li><code>true</code>: è°ƒç”¨ç³»ç»Ÿçš„<code>DownloadManager</code>è¿›è¡Œä¸‹è½½
<ul>
<li>ä¼˜åŠ¿ï¼šæ¥å…¥ç®€å•ï¼Œæ— éœ€æ‹…å¿ƒæ“ä½œï¼Œä¸‹è½½å…¨ç”±ç³»ç»Ÿç®¡ç†</li>
<li>åŠ£åŠ¿ï¼šæ— æ³•ä½¿ç”¨httpæ–¹å¼è¿›è¡Œä¸‹è½½ï¼Œæ— æ³•åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­ç‚¹å‡»é€šçŸ¥æ è¿›è¡Œæš‚åœï¼Œæ— æ³•æ ¹æ®æœ‰æ— ç½‘ç»œè¿›è¡Œæš‚åœå’Œç»§ç»­ä¸‹è½½ï¼Œé€‚é…æœºå‹é—®é¢˜ç­‰</li>
<li>æ”¯æŒçš„æ–¹æ³•ï¼š<code>RUpgrade.stream</code>ã€<code>install</code>ã€<code>cancel</code></li>
</ul>
</li>
<li><code>false</code>: è°ƒç”¨<code>Service</code>è¿›è¡Œä¸‹è½½ï¼ˆé»˜è®¤ä½¿ç”¨ï¼‰
<ul>
<li>ä¼˜åŠ¿ï¼šåŠŸèƒ½è¾ƒå…¨ï¼Œæ”¯æŒhttp/httpsä¸‹è½½ï¼Œæ”¯æŒç½‘ç»œæ–­å¼€åè‡ªåŠ¨æš‚åœä¸‹è½½ï¼Œè¿æ¥ä¸Šåç»§ç»­ä¸‹è½½ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œæ”¯æŒæŸ¥è¯¢æœ€åä¸€æ¬¡ä¸‹è½½ç­‰</li>
<li>åŠ£åŠ¿ï¼šæš‚æ— å‘ç°ï¼Œå¦‚æœå‘ç°bugæ¬¢è¿æissue.</li>
<li>æ”¯æŒçš„æ–¹æ³•ï¼šé»˜è®¤å…¨éƒ¨</li>
</ul>
</li>
</ul>
<pre><code class="language-dart">    // [isAutoRequestInstall] ä¸‹è½½å®Œæˆåè‡ªåŠ¨å¼¹å‡ºå®‰è£…
    // [apkName] å®‰è£…åŒ…çš„åå­—ï¼ˆéœ€è¦åŒ…å«.apkï¼‰
    // [notificationVisibility] é€šçŸ¥æ æ˜¾ç¤ºæ–¹å¼
    // [useDownloadManager] æ˜¯å¦ä½¿ç”¨DownloadManagerï¼Œé»˜è®¤ä¸ä½¿ç”¨ï¼ˆDownloadManagerä¸æ”¯æŒhttpä¸‹è½½ï¼Œä¸‹è½½æ‰‹åŠ¨æš‚åœï¼Œæ–­ç‚¹ç»­ä¼ ç­‰ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼‰
    // [upgradeFlavor] å‡çº§çš„å£å‘³ï¼Œé»˜è®¤å…¨é‡å‡çº§ï¼ˆé»˜è®¤ï¼‰
    void upgrade() async {
      int id = await RUpgrade.upgrade(
                 'https://raw.githubusercontent.com/rhymelph/r_upgrade/master/apk/app-release.apk',
                 apkName: 'app-release.apk',isAutoRequestInstall: true);
    }
</code></pre>
<p>æ–°å¢å‡çº§çš„å£å‘³ï¼š(ä¸æ”¯æŒä½¿ç”¨DownloadManagerä¸‹è½½)</p>
<pre><code class="language-dart">enum RUpgradeFlavor {
  normal, // å…¨é‡å‡çº§
  hotUpgrade, // çƒ­æ›´æ–°
  incrementUpgrade, // å¢é‡å‡çº§
}
</code></pre>
<h4>3. å–æ¶ˆä¸‹è½½</h4>
<pre><code class="language-dart">    void cancel() async {
      bool isSuccess=await RUpgrade.cancel(id);
    }
</code></pre>
<h4>4. å®‰è£…åº”ç”¨</h4>
<pre><code class="language-dart">    void install() async {
      bool isSuccess=await RUpgrade.install(id);
    }
</code></pre>
<h4>5. æš‚åœä¸‹è½½</h4>
<pre><code class="language-dart">    void pause() async {
      bool isSuccess=await RUpgrade.pause(id);
    }
</code></pre>
<h4>6. ç»§ç»­ä¸‹è½½</h4>
<pre><code class="language-dart">    void pause() async {
      bool isSuccess=await RUpgrade.upgradeWithId(id);
      // è¿”å› false å³è¡¨ç¤ºä»æ¥ä¸å­˜åœ¨æ­¤ID
      // è¿”å› true
      //    è°ƒç”¨æ­¤æ–¹æ³•å‰çŠ¶æ€ä¸º [STATUS_PAUSED]ã€[STATUS_FAILED]ã€[STATUS_CANCEL],å°†ç»§ç»­ä¸‹è½½
      //    è°ƒç”¨æ­¤æ–¹æ³•å‰çŠ¶æ€ä¸º [STATUS_RUNNING]ã€[STATUS_PENDING]ï¼Œä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŒ–
      //    è°ƒç”¨æ­¤æ–¹æ³•å‰çŠ¶æ€ä¸º [STATUS_SUCCESSFUL]ï¼Œå°†ä¼šå®‰è£…åº”ç”¨
      // å½“æ–‡ä»¶è¢«åˆ é™¤æ—¶ï¼Œé‡æ–°ä¸‹è½½
    }
</code></pre>
<h4>7. è·å–æœ€åä¸€æ¬¡ä¸‹è½½çš„ID</h4>
<p>è¯¥æ–¹æ³•åªä¼šå¯»æ‰¾å½“å‰åº”ç”¨ç‰ˆæœ¬åå’Œç‰ˆæœ¬å·ä¸‹ä¸‹è½½è¿‡çš„ID</p>
<pre><code class="language-dart">    void getLastUpgradeId() async {
     int id = await RUpgrade.getLastUpgradedId();
    }
</code></pre>
<h4>8. è·å–IDå¯¹åº”çš„ä¸‹è½½çŠ¶æ€</h4>
<pre><code class="language-dart">    void getDownloadStatus()async{
    DownloadStatus status = await RUpgrade.getDownloadStatus(id);
   }
</code></pre>
<h4>9. å¢é‡å‡çº§</h4>
<ul>
<li>1.ä¸‹è½½<a href="https://github.com/rhymelph/r_upgrade/releases/download/v0.3.0/bsdiff">bsdiff</a>å·¥å…·åˆ°æœ¬åœ°</li>
<li>2.å‡†å¤‡ä¸¤ä¸ªå®‰è£…åŒ…ï¼Œä¸€ä¸ªæ˜¯å³å°†éœ€è¦å‡çº§çš„å®‰è£…åŒ…(old.apk)ã€ä¸€ä¸ªæ˜¯ä½ éœ€è¦æ›´æ–°çš„å®‰è£…åŒ…ï¼ˆnew.apkï¼‰</li>
<li>3.åœ¨å‘½ä»¤è¡Œåˆ‡æ¢åˆ°ä¸Šé¢ä¸‹è½½çš„<code>bsdiff</code>ç›®å½•ä¸‹ï¼Œè¿è¡Œå‘½ä»¤<code>./bsdiff old.apk new.apk increment.patch</code></li>
<li>4.å°†ä¸Šé¢ç”Ÿæˆçš„<code>increment.patch</code>ä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
<li>5.è°ƒç”¨<code>RUpgrade.upgradeï¼ˆ...,upgradeFlavor:RUpgradeFlavor.incrementUpgradeï¼‰</code>æ–¹æ³•è¿›è¡Œä¸‹è½½ï¼Œå³å¯</li>
<li>6.è°ƒç”¨<code>RUpgrade.install(id)</code>è¿›è¡Œå®‰è£…</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-dart">    int id;
    void incrementUpgrade(){
        id = await RUpgrade.upgrade(
                'https://mydata-1252536312.cos.ap-guangzhou.myqcloud.com/r_upgrade.patch',
                fileName: 'r_upgrade.patch',
                useDownloadManager: false,
                isAutoRequestInstall: false,
                upgradeFlavor: RUpgradeFlavor.incrementUpgrade,
              );
    }

    void install(){
        try {
            await RUpgrade.install(id);
        } catch (e) {
            _state.currentState
                .showSnackBar(SnackBar(content: Text('å¢é‡æ›´æ–°å¤±è´¥!')));
        }
    }
</code></pre>
<h4>10. çƒ­æ›´æ–°</h4>
<ul>
<li>ä½ å¯ä»¥ä½¿ç”¨å‡çº§è¿”å›çš„<code>id</code>è¿›è¡Œçƒ­æ›´æ–°ï¼Œä¸‹è½½çš„æ–‡ä»¶éœ€è¦å°†æ–°ç‰ˆæœ¬ç”Ÿæˆçš„<code>isolate_snapshot_data</code>ã€<code>kernel_blob.bin</code>ã€<code>vm_snapshot_data</code>æ‰“è¿›zipæ–‡ä»¶ä¸­ä¸‹è½½
æ­¥éª¤ï¼š
<ul>
<li>è¿è¡Œ <code>flutter clean</code> æ¸…ç†buildæ–‡ä»¶</li>
<li>è¿è¡Œ <code>flutter build bundle</code> ç”Ÿæˆéœ€è¦çš„äº§ç‰©ï¼Œä¸‹é¢æ ‡è®°æ˜Ÿå·ä¸ºå¿…é¡»æ–‡ä»¶</li>
</ul>
</li>
</ul>
<pre><code>|- AssetManifest.json
|- FontManifest.json
|- fonts
    |- ...
|- isolate_snapshot_data *
|- kernel-blob.bin       *
|- LICENSE
|- packages
    |- ...
|- vm_snapshot_data      *
</code></pre>
<pre><code>- å°†æ ‡è®°æ˜Ÿå·çš„æ–‡ä»¶æ‰“åŒ…æˆzipæ–‡ä»¶ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨
- è°ƒç”¨`RUpgrade.upgradeï¼ˆ...,upgradeFlavor:RUpgradeFlavor.hotUpgradeï¼‰`æ–¹æ³•è¿›è¡Œä¸‹è½½
- ä¸‹è½½å®Œæˆåï¼Œå°†ä¸Šé¢è·å–åˆ°çš„idè¿›è¡Œçƒ­æ›´æ–°,è°ƒç”¨å¦‚ä¸‹ä»£ç 
</code></pre>
<pre><code class="language-dart">           bool isSuccess = await RUpgrade.install(id);
           if (isSuccess) {
              _state.currentState
                    .showSnackBar(SnackBar(content: Text('çƒ­æ›´æ–°æˆåŠŸï¼Œ3såé€€å‡ºåº”ç”¨ï¼Œè¯·é‡æ–°è¿›å…¥')));
                Future.delayed(Duration(seconds: 3)).then((_){
                  SystemNavigator.pop(animated: true);
                });
           }else{
              _state.currentState
                    .showSnackBar(SnackBar(content: Text('çƒ­æ›´æ–°å¤±è´¥ï¼Œè¯·ç­‰å¾…æ›´æ–°åŒ…ä¸‹è½½å®Œæˆ')));
              }
</code></pre>
<pre><code>- é‡å¯åº”ç”¨å³å¯
</code></pre>
<blockquote>
<p>æ³¨æ„ï¼šç›®å‰çƒ­æ›´æ–°å°šå¤„äºæµ‹è¯•é˜¶æ®µï¼Œåªæ”¯æŒFlutterä»£ç çš„å˜æ›´ï¼Œä¸æ”¯æŒèµ„æºæ–‡ä»¶ç­‰ï¼Œçƒ­æ›´æ–°é€ æˆçš„ä¸€åˆ‡çš„åæœæ’ä»¶çš„ä½œè€…æ¦‚ä¸è´Ÿè´£ï¼Œç”±ä½¿ç”¨è€…æ‰¿æ‹…ã€‚</p>
</blockquote>
<h2>å®‰å“å¹³å°é€šçŸ¥æ </h2>
<p>å¦‚æœä½ æƒ³è‡ªå®šä¹‰é€šçŸ¥æ æ˜¾ç¤ºçš„å†…å®¹, å¯ä»¥è¿™æ ·åš, ä¿®æ”¹æˆ–æ·»åŠ æ–‡ä»¶è·¯å¾„ä¸º<code>project/android/app/main/res/r_upgrade_value.xml</code>ï¼Œæ·»åŠ ä¸‹é¢ä»£ç </p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;resources&gt;
    &lt;string name="r_upgrade_download_speech"&gt;%.2fkb/s&lt;/string&gt;
    &lt;string name="r_upgrade_download_planTime"&gt;é¢„è®¡%.0fç§’åå®Œæˆ&lt;/string&gt;
    &lt;string name="r_upgrade_download_finish"&gt;ä¸‹è½½å®Œæˆ&lt;/string&gt;
    &lt;string name="r_upgrade_download_paused"&gt;ä¸‹è½½è¢«æš‚åœ&lt;/string&gt;
    &lt;string name="r_upgrade_download_failed"&gt;ä¸‹è½½å¤±è´¥&lt;/string&gt;
&lt;/resources&gt;
</code></pre>
<p>ç„¶å.å½“ä½ ä½¿ç”¨<code>upgrade</code>æ–¹æ³•æ—¶,ä½ åº”è¯¥è®¾ç½®å‚æ•°<code>notificationStyle</code>ï¼Œé»˜è®¤ä¸ºæ˜¾ç¤ºé¢„è®¡å®Œæˆæ—¶é—´.</p>
<pre><code class="language-dart">/// Notification show style about content text
enum NotificationStyle {
  speechAndPlanTime, // 100kb/s é¢„è®¡1ç§’åå®Œæˆ
  planTimeAndSpeech, // é¢„è®¡1ç§’åå®Œæˆ 100kb/s
  speech,// 100kb/s
  planTime, // é¢„è®¡1ç§’åå®Œæˆ
  none, //
}
</code></pre>
<h2>IOSå¹³å°</h2>
<h3>1.è·³è½¬åˆ°AppStoreè¿›è¡Œæ›´æ–°</h3>
<pre><code class="language-dart">    void upgradeFromAppStore() async {
        bool isSuccess =await RUpgrade.upgradeFromAppStore(
                'æ‚¨çš„AppId',//ä¾‹å¦‚:å¾®ä¿¡çš„AppId:414478124
              );
        print(isSuccess);
    }
</code></pre>
<h3>2.è·å–AppStoreä¸­ä½ çš„åº”ç”¨æœ€åçš„ç‰ˆæœ¬å</h3>
<pre><code class="language-dart">    void getVersionFromAppStore() async {
        String versionName = await RUpgrade.getVersionFromAppStore(
                'æ‚¨çš„AppId',//ä¾‹å¦‚:å¾®ä¿¡çš„AppId:414478124
               );
        print(versionName);
    }
</code></pre>
<blockquote>
<p>ç»“å°¾ï¼šDartå®¢æ ˆå·²ç»æ¨å‡º<code>Aqueductæ¡†æ¶ç³»åˆ—æ•™ç¨‹</code>ä¸“è¾‘ï¼Œæ¬¢è¿å–œæ¬¢å­¦ä¹ Dartè¯­è¨€å¼€å‘çš„å°ä¼™ä¼´å…³æ³¨ğŸ‘ğŸ‘</p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2020/6/12/172a7121edeecc29?w=1280&h=1280&f=png&s=523911" alt="" /></p>
